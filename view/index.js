!function(window,document,JSON){"use strict";let SimpleUndo=require("simple-undo");class UndoManager{constructor(){this.state={imageDimensions:null,imageSrc:null};this.history=new SimpleUndo({maxLength:10,provider:function(done){return done(JSON.stringify(this.state))}.bind(this)});this.history.initialize(JSON.stringify(this.state));this.unserializer=function(serialized){this.state=JSON.parse(serialized);let imageDimensions=this.state.imageDimensions,imageSrc=this.state.imageSrc;if(imageSrc!=null){window.negative.frameController.setImageAndSize(imageSrc,imageDimensions[0],imageDimensions[1])}else{window.negative.frameController.removeImage()}}.bind(this)}save(state){this.state=state;this.history.save()}undo(){this.history.undo(this.unserializer)}redo(){this.history.redo(this.unserializer)}canUndo(){return this.history.canUndo()}canRedo(){return this.history.canRedo()}serialize(){return{canUndo:this.canUndo(),canRedo:this.canRedo()}}}let ipc=require("electron").ipcRenderer;class NegativeFrame{constructor(){this.imageContainer=document.getElementById("imageContainer");this.currentImage=document.getElementById("negativeImage");this.currentImage.addEventListener("load",function(){document.body.classList.add("negative-on")},false);ipc.send("get-settings-request");ipc.on("get-settings-response",function(evt,settings){if(settings["shouldShowTips"]===false){document.body.classList.add("no-tips")}}.bind(this))}setShouldShowTips(shouldShowTips){if(shouldShowTips){document.body.classList.remove("no-tips")}else{document.body.classList.add("no-tips")}}setImageAndSize(src,width,height){if(src){document.body.classList.add("negative-on");this.currentImage.setAttribute("src",src);let newWidth=width+"px",newHeight=height+"px";this.currentImage.style.width=newWidth;this.currentImage.style.height=newHeight;this.imageContainer.style.width=newWidth;this.imageContainer.style.height=newHeight;window.negative.tabsController.setTabHasContent();window.negative.tabsController.setTabLabel(width+"x"+height)}}removeImage(){document.body.classList.remove("negative-on");this.currentImage.setAttribute("src","");window.negative.tabsController.unsetTabHasContent();window.negative.tabsController.setTabLabel("")}setFocused(){document.body.classList.remove("blur");document.body.classList.add("focus")}unsetFocused(){document.body.classList.remove("focus");document.body.classList.add("blur")}setPrimary(){document.body.classList.add("primary")}unsetPrimary(){document.body.classList.remove("primary")}}let clipboard=require("clipboard"),nativeImage=require("native-image"),remote=require("electron").remote,BrowserWindow=remote.BrowserWindow;class NegativeTabs{constructor(){this.tabIndex=0;this.tabs=[this.getEmptyModel()];this.tabsContainer=document.getElementById("tabs");let dragOverIndex=null;this.tabsContainer.addEventListener("mousedown",function(evt){let target=evt.target;if(target){if(target.classList.contains("tab")){this.deselectTabByIndex(this.tabIndex);this.tabIndex=Array.from(this.tabsContainer.children).indexOf(target);this.selectTabByIndex(this.tabIndex)}else if(target.classList.contains("close")){this.closeTab()}}}.bind(this),false);this.tabsContainer.addEventListener("dragstart",function(evt){let target=evt.target;if(target){if(target.classList.contains("tab")&&this.tabs.length>1){evt.dataTransfer.setData("from-index",`${this.tabIndex}`);evt.dataTransfer.effectAllowed="move"}else{evt.preventDefault();return false}}}.bind(this));this.tabsContainer.addEventListener("dragover",function(evt){evt.preventDefault();let leftOffset=70,x=evt.x-leftOffset,toIndex=Math.floor(x/126),fromIndex=+evt.dataTransfer.getData("from-index");if(toIndex!==dragOverIndex){let newTransform=(toIndex-fromIndex)*126+"px";this.tabsContainer.children[fromIndex].style.left=newTransform;dragOverIndex=toIndex}for(let i=0,len=this.tabsContainer.children.length;i<len;i++){let tab=this.tabsContainer.children[i];if(fromIndex>i){if(toIndex<=i){tab.classList.add("shift-right")}else{tab.classList.remove("shift-right")}}else if(fromIndex<i){if(toIndex>=i){tab.classList.add("shift-left")}else{tab.classList.remove("shift-left")}}}}.bind(this));this.tabsContainer.addEventListener("dragend",function(evt){}.bind(this));this.tabsContainer.addEventListener("drop",function(evt){evt.preventDefault();let target=evt.target;if(target&&target.classList.contains("tab")){let leftOffset=70,x=evt.x-leftOffset,toIndex=Math.floor(x/126),spliceToIndex=toIndex>fromIndex?toIndex+1:toIndex,fromIndex=+evt.dataTransfer.getData("from-index");this.moveTab(fromIndex,spliceToIndex);this.tabs.splice(spliceToIndex,this.tabs.splice(fromIndex,1,null)[0]);this.tabs=this.tabs.filter(function(tab){return tab!==null});this.tabIndex=toIndex;this.tabsContainer.classList.add("shift-none");setTimeout(function(){this.tabsContainer.classList.remove("shift-none")}.bind(this),250);Array.from(this.tabsContainer.children).forEach(function(tab){tab.style.transform="";tab.style.left="";dragOverIndex=null;setTimeout(function(){tab.classList.remove("shift-left","shift-right")}.bind(this),250)}.bind(this))}}.bind(this));document.getElementById("close").addEventListener("click",function(evt){BrowserWindow.getFocusedWindow().close()});document.getElementById("minimize").addEventListener("click",function(evt){BrowserWindow.getFocusedWindow().minimize()});document.getElementById("maximize").addEventListener("click",function(evt){BrowserWindow.getFocusedWindow().maximize()})}addTab(){this.deselectTabByIndex(this.tabIndex);this.tabIndex++;let newTabButton=this.getTabButtonElement(true);this.tabsContainer.insertBefore(newTabButton,this.getCurrentTab());newTabButton.focus();this.tabs.splice(this.tabIndex,0,this.getEmptyModel());window.negative.frameController.removeImage();this.refreshMenu()}closeTab(){let closedTabIndex=this.tabIndex;if(!this.canSelectNextTab()){if(this.canSelectPreviousTab()){this.tabIndex--}else{BrowserWindow.getFocusedWindow().close();return}}this.tabsContainer.children[closedTabIndex].remove();this.tabs.splice(closedTabIndex,1);this.selectTabByIndex(this.tabIndex)}getCurrentTab(){return this.tabsContainer.children[this.tabIndex]}moveTab(fromIndex,toIndex){this.tabsContainer.insertBefore(this.tabsContainer.children[fromIndex],this.tabsContainer.children[toIndex])}canSelectNextTab(){return this.tabIndex+1<this.tabs.length}canSelectPreviousTab(){return this.tabIndex>0}selectTabByIndex(index){let newTab=this.tabs[index].undoManager.state,newTabButton=this.tabsContainer.children[index],imageSrc=newTab.imageSrc,imageDimensions=newTab.imageDimensions;newTabButton.classList.add("selected");newTabButton.setAttribute("aria-selected","true");newTabButton.focus();if(imageSrc&&imageDimensions){window.negative.frameController.setImageAndSize(imageSrc,imageDimensions[0],imageDimensions[1])}else{window.negative.frameController.removeImage()}this.refreshMenu()}deselectTabByIndex(index){let oldTab=this.tabsContainer.children[index];oldTab.classList.remove("selected");oldTab.setAttribute("aria-selected","false")}selectNextTab(){let canSelectNextTab=this.canSelectNextTab();if(canSelectNextTab){this.deselectTabByIndex(this.tabIndex);this.tabIndex++;this.selectTabByIndex(this.tabIndex)}return canSelectNextTab}selectPreviousTab(){let canSelectPreviousTab=this.canSelectPreviousTab();if(canSelectPreviousTab){this.deselectTabByIndex(this.tabIndex);this.tabIndex--;this.selectTabByIndex(this.tabIndex)}return canSelectPreviousTab}setTabHasContent(){this.getCurrentTab().classList.add("has-content")}unsetTabHasContent(){this.getCurrentTab().classList.remove("has-content")}setTabLabel(label){this.getCurrentTab().children[0].textContent=label}getEmptyModel(){return{undoManager:new UndoManager}}getTabButtonElement(isSelected){let tabDiv=document.createElement("div"),labelSpan=document.createElement("span"),closeButton=document.createElement("button");tabDiv.classList.add("tab");tabDiv.setAttribute("draggable","true");labelSpan.classList.add("label");closeButton.classList.add("close");closeButton.setAttribute("aria-label","close");closeButton.innerHTML="&times;";if(isSelected){tabDiv.classList.add("selected");tabDiv.setAttribute("aria-selected","true")}tabDiv.appendChild(labelSpan);tabDiv.appendChild(closeButton);return tabDiv}saveForUndo(state){let undoManager=this.tabs[this.tabIndex].undoManager;undoManager.save(state);this.refreshMenu()}undo(){let undoManager=this.tabs[this.tabIndex].undoManager;undoManager.undo();this.refreshMenu()}redo(){let undoManager=this.tabs[this.tabIndex].undoManager;undoManager.redo();this.refreshMenu()}copy(){let undoManagerState=this.tabs[this.tabIndex].undoManager.state,imageSrc=undoManagerState.imageSrc,imageDimensions=undoManagerState.imageDimensions;if(imageSrc!==null&&imageDimensions!==null){clipboard.write({image:nativeImage.createFromDataURL(imageSrc),text:JSON.stringify(imageDimensions)});this.refreshMenu()}}paste(){let image=clipboard.readImage(),imageDimensions;try{imageDimensions=JSON.parse(clipboard.readText()||null)}catch(err){}if(image!==null){if(!imageDimensions){imageDimensions=function(dims){return[dims.width,dims.height]}(image.getSize())}let imageSrc=image.toDataURL();window.negative.frameController.setImageAndSize(imageSrc,imageDimensions[0],imageDimensions[1]);this.saveForUndo({imageSrc:imageSrc,imageDimensions:imageDimensions});this.refreshMenu()}}refreshMenu(){let undoManager=this.tabs[this.tabIndex].undoManager;ipc.send("refresh-menu",{canAddTab:true,canCloseTab:true,canCloseWindow:true,canUndo:undoManager.canUndo(),canRedo:undoManager.canRedo(),canCapture:true,isImageEmpty:undoManager.state.imageSrc===null,canReload:true,canToggleDevTools:true,canSelectPreviousTab:this.canSelectPreviousTab(),canSelectNextTab:this.canSelectNextTab(),canMinimize:true,canMove:true})}fitWindowToImage(){let undoManagerState=this.tabs[this.tabIndex].undoManager.state;ipc.send("fit-window-to-image",undoManagerState.imageDimensions)}}document.addEventListener("DOMContentLoaded",function(){window.negative={frameController:new NegativeFrame,tabsController:new NegativeTabs}})}(window,document,JSON);